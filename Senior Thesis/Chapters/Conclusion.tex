% !TEX root = ../Thesis.tex
\chapter{Conclusion}

Superpages are a useful tool for increasing the reach of the TLB. Every time a memory address is accessed, it must be translated to a physical address. If that translation is not cached in the TLB, a time-consuming page table walk occur. By managing memory in 2MB superpages instead of 4KB small pages, each TLB entry can represent a larger region of memory and thus TLB misses can be reduced. However, using superpages means that memory properties can only be managed in 2MB blocks, so applications such as copy-on-write suffer from the lack of fine-grained memory management.

This work presents a system called superpage overlays that allows fine-grained management of memory within superpages. Superpage overlays involve both hardware and software changes in the form of bit vectors appended to TLB entries, a special-purpose register for a new page table hierarchy, and updated kernel memory management code that creates and maintains overlays. We have shown that superpage overlays can grant most of the TLB benefits of superpages while still allowing copy-on-write operations to minimize memory duplication.

Additionally, we have developed a trap-driven simulation framework. This system has several benefits over more typical trace-driven simulation in the form of less overhead and real-time access to the system. The framework could be used to simulate nearly any TLB modification, as long as TLB misses and kernel-maintained data structures provide enough information to update the simulation.

\section{Future Work}
The most significant future work is to evaluate superpage overlays on a virtualized workload. When a virtual machine runs on a modern system, two-dimensional page tables are used to allow the guest to maintain its own virtual memory system within the host. Two-dimensional paging does separate page table walks to translate addresses between guest virtual and guest physical (which is host virtual), and between host virtual and host physical. Since the guest's page tables themselves have guest physical addresses that must be translated, this increases the cost of a page table walk from 4 memory accesses to 24 for small pages \cite{Bhargava}. It also increases TLB pressure because there are more translations to cache. Both of these facts are strong arguments for improving superpage utilization for virtualized systems, which superpage overlays can do.

Both GLUE \cite{Pham} and SpecTLB \cite{Barr} emphasize virtual machines as their primary targets for performance improvement. Pham \emph{et al.} found that virtual machines generally create superpages via the THP mechanism, but these superpages are regularly split due to finer-grained memory management needs. Supuerpage overlays would eliminate these splits and greatly increase the superpage utilization in these workloads.

Virtualized systems were not covered in this work due to difficulties with the trap-driven simulation. The way virtual memory is handled in VMs is greatly complicated by the two-dimensional page tables and Intel's virtual machine extensions, which allow virtual machines to handle page faults without passing them to the host. Thus, the simulation framework may need substantial upgrades in order to observe the frequent superpage splitting behavior that overlays could improve upon.
